<!-- build time:Tue Jun 09 2020 08:35:11 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png?v=5.1.4"><meta name="keywords" content="J.U.C,锁,"><link rel="alternate" href="/atom.xml" title="oncevan的个人小站" type="application/atom+xml"><meta name="description" content="1、Lock接口1.1、Lock简介、地位、作用锁是一种工具，用于控制对共享资源的访问Lock和synchronized，这两个是最常见的锁，它们都可以达到线程安全的目的，但是在使用和功能上又有较大的不同Lock并不是用来替代synchronized的，而是当使用synchronized不合适或不足以满足要求的时候，来提供高级功能的。Lock接口最常见的实现类是ReentrantLock通常情况下"><meta property="og:type" content="article"><meta property="og:title" content="锁"><meta property="og:url" content="https://oncevan/oncevan.github.io/2020/04/28/%E9%94%81/index.html"><meta property="og:site_name" content="oncevan的个人小站"><meta property="og:description" content="1、Lock接口1.1、Lock简介、地位、作用锁是一种工具，用于控制对共享资源的访问Lock和synchronized，这两个是最常见的锁，它们都可以达到线程安全的目的，但是在使用和功能上又有较大的不同Lock并不是用来替代synchronized的，而是当使用synchronized不合适或不足以满足要求的时候，来提供高级功能的。Lock接口最常见的实现类是ReentrantLock通常情况下"><meta property="og:image" content="http://pics.oncevan.cn/img/1585827815437.png"><meta property="og:image" content="https://img2018.cnblogs.com/blog/1621069/201909/1621069-20190908153101303-1789310261.png"><meta property="og:image" content="http://pics.oncevan.cn/img/1585827954346.png"><meta property="og:image" content="http://pics.oncevan.cn/img/1586052986905.png"><meta property="og:image" content="http://pics.oncevan.cn/img/1586055172117.png"><meta property="og:image" content="http://pics.oncevan.cn/img/1586055192675.png"><meta property="article:published_time" content="2020-04-28T11:34:15.000Z"><meta property="article:modified_time" content="2020-06-09T00:24:46.140Z"><meta property="article:author" content="Evan Chou"><meta property="article:tag" content="J.U.C"><meta property="article:tag" content="锁"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://pics.oncevan.cn/img/1585827815437.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://oncevan/oncevan.github.io/2020/04/28/锁/"><title>锁 | oncevan的个人小站</title><meta name="generator" content="Hexo 4.2.1"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">oncevan的个人小站</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://oncevan/oncevan.github.io/2020/04/28/%E9%94%81/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Evan Chou"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="oncevan的个人小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">锁</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-28T19:34:15+08:00">2020-04-28 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/J-U-C/" itemprop="url" rel="index"><span itemprop="name">J.U.C</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3.3k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11 mins</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、Lock接口"><a href="#1、Lock接口" class="headerlink" title="1、Lock接口"></a>1、Lock接口</h2><h3 id="1-1、Lock简介、地位、作用"><a href="#1-1、Lock简介、地位、作用" class="headerlink" title="1.1、Lock简介、地位、作用"></a>1.1、Lock简介、地位、作用</h3><ul><li>锁是一种工具，用于控制对共享资源的访问</li><li><code>Lock</code>和<code>synchronized</code>，这两个是最常见的锁，它们都可以达到线程安全的目的，但是在使用和功能上又有较大的不同</li><li><code>Lock</code>并不是用来替代<code>synchronized</code>的，而是当使用<code>synchronized</code>不合适或不足以满足要求的时候，来提供高级功能的。</li><li><code>Lock</code>接口最常见的实现类是<code>ReentrantLock</code></li><li>通常情况下，<code>Lock</code>只允许一个线程来访问这个共享资源。不过有的时候，一些特殊的实现也允许并发访问，比如<code>ReadWriteLock</code>里面的<code>ReadLock</code>。</li></ul><a id="more"></a><h4 id="1-2、为什么synchronized不够用？（为什么需要Lock？）"><a href="#1-2、为什么synchronized不够用？（为什么需要Lock？）" class="headerlink" title="1.2、为什么synchronized不够用？（为什么需要Lock？）"></a>1.2、为什么synchronized不够用？（为什么需要Lock？）</h4><p>1、<strong>效率低</strong>：锁的释放情况少，试图获得锁时不能设定超时、不 能中断一个正在试图获得锁的线程</p><p>2、<strong>不够灵活（读写锁更灵活）</strong>：加锁和释放的时机单一，每个锁仅有单一的条件（某个对象），可能时不够的</p><p>3、无法知道<strong>是否成功获取到锁</strong></p><h4 id="1-3、Lock方法"><a href="#1-3、Lock方法" class="headerlink" title="1.3、Lock方法"></a>1.3、Lock方法</h4><ul><li><code>Lock（）</code>就是最普通的获取锁。如果锁已被其他线程获取，则进行等待</li><li><code>Lock</code>不会像<code>synchronized</code>一样在<strong>异常的时候自动释放锁</strong>，因此最佳实践是，<strong>在finally中释放锁</strong>，以保证发生异常时锁一定被释放</li><li><code>Lock</code>()方法不能被中断，这会带来很大的隐患：一旦陷入死锁，<code>Lock</code>()就会陷入永远等待</li></ul><h4 id="tryLock-、tryLock-long-time-TimeUnit-unit-、lockInterruptibly"><a href="#tryLock-、tryLock-long-time-TimeUnit-unit-、lockInterruptibly" class="headerlink" title="tryLock()、tryLock(long time,TimeUnit unit)、lockInterruptibly()"></a>tryLock()、tryLock(long time,TimeUnit unit)、lockInterruptibly()</h4><ul><li><code>tryLock()</code>用来尝试获取锁，如果当前锁没有被其他线程占用，则获取成功返回true，否则返回false代表获取锁失败。相比于<code>Lock</code>，这样的方法显然功能更强大了，我们可以根据是否能获取到锁来决定后续程序的行为。该方法会立即返回，即便在拿不到锁时也不会一直等着。</li><li><code>tryLock(long time,TimeUnit unit)</code>：超时就放弃</li><li><code>lockInterruptibly():</code>相当于tryLock(long time,TimeUnit unit)把超时时间设置为无限。在等待锁的过程中，线程可以被中断</li></ul><h4 id="1-4、Lock的可见性保证"><a href="#1-4、Lock的可见性保证" class="headerlink" title="1.4、Lock的可见性保证"></a>1.4、Lock的可见性保证</h4><p><img src="http://pics.oncevan.cn/img/1585827815437.png" alt=""></p><h3 id="拓展：happens-before"><a href="#拓展：happens-before" class="headerlink" title="拓展：happens-before"></a>拓展：happens-before</h3><p><strong>它真正的意思是前面的操作对后续的操作都是可见的</strong>，比如 A happen before B 的意思并不是说 A 操作发生在 B 操作之前，而是说 A 操作对于 B 操作一定是可见的。</p><p><img src="https://img2018.cnblogs.com/blog/1621069/201909/1621069-20190908153101303-1789310261.png" alt=""></p><h2 id="2、锁的分类"><a href="#2、锁的分类" class="headerlink" title="2、锁的分类"></a>2、锁的分类</h2><p><img src="http://pics.oncevan.cn/img/1585827954346.png" alt=""></p><h3 id="2-1、乐观锁和悲观锁"><a href="#2-1、乐观锁和悲观锁" class="headerlink" title="2.1、乐观锁和悲观锁"></a>2.1、乐观锁和悲观锁</h3><p><strong>悲观锁</strong>：悲观锁又称<strong>互斥同步锁</strong>，悲观锁为了确保结果的正确性，会每次获取并修改数据时，把数据锁住，让其他线程无法访问数据，这样就可以确保数据内容万无一失。比如<code>synchronized</code>和<code>Lock</code>接口。改进的<code>synchronized</code>前面会有乐观的一部分！</p><p><strong>乐观锁</strong>：乐观锁又称<strong>非互斥同步锁</strong>，乐观锁在操作同步资源的时候不会锁住被操作的对象，在更新的时候，去对比在我修改的期间数据有没有被其他人改变过，如果没有被改变过，就说明真的是只有自己在操作，那就正常去修改数据，如果数据和一开始拿到的不一样了，说明其他线程在这段时间内改过数据，那就不能继续刚才的更新数据过程了，我会选择放弃、报错、重试等策略。乐观锁的实现一般都 是利用<code>CAS算法</code>来实现的。<strong>乐观锁的典型例子就是原子类、并发容器等</strong>。</p><p>悲观锁的劣势</p><ul><li>阻塞和唤醒带来的性能劣势</li><li>永久阻塞：如果持有锁的线程被永久阻塞，比如遇到无限循环、死锁等活跃性问题，那么等待该线程释放锁的那几个悲催的线程将永远得不到执行</li><li>优先级反转：假如给线程设置了优先级，一旦优先级低的线程拿到同步资源后不运行或运行很慢，那么即便其他线程优先级很高也是不能执行的，这就是优先级反转</li></ul><h4 id="开销对比"><a href="#开销对比" class="headerlink" title="开销对比"></a>开销对比</h4><ul><li>悲观锁的原始开销要高于乐观锁，但是特点是一劳永逸，临界区持锁时间就算越来越长，也不会对互斥锁的开销造成影响</li><li>相反，虽然乐观锁一开始的开销比悲观锁小，但是如果自旋时间很长或者不停重试，那么消耗的资源也会越来越多</li></ul><h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul><li>悲观锁：适合并发写入多的情况，适用于临界区持锁时间比较长的情况，悲观锁可以避免大量的无用自旋的消耗，典型情况：<ul><li>临界区有<strong>IO操作</strong></li><li>临界区<strong>代码复杂</strong>或者循环量大</li><li>临界区<strong>竞争非常激烈</strong></li></ul></li><li>乐观锁：适合并发写入少，大部分是读取的场景，不加锁的能让读取性能大幅提高</li></ul><h3 id="2-2、可重入锁和非可重入锁"><a href="#2-2、可重入锁和非可重入锁" class="headerlink" title="2.2、可重入锁和非可重入锁"></a>2.2、可重入锁和非可重入锁</h3><p><code>可重入锁ReentrantLock</code>：已获取锁后，再次获取该锁无需释放第一次获得的锁，这就是可重入锁 。（避免死锁，提升封装性）</p><p><code>不可重入</code>：已获取锁后，想要获得同一把锁必须先释放该锁，这就是非可重入锁</p><p><img src="http://pics.oncevan.cn/img/1586052986905.png" alt=""></p><h3 id="2-3、公平锁与非公平锁"><a href="#2-3、公平锁与非公平锁" class="headerlink" title="2.3、公平锁与非公平锁"></a>2.3、公平锁与非公平锁</h3><p><code>公平</code>指的是按照线程请求的顺序来分配锁；<code>非公平</code>指的是不完全按照请求的顺序，在一定情况下可以插队。</p><p>注意：非公平也同样不提倡“插队”行为，这里的非公平指的是在<strong>“合适的时机”</strong>插队，而不是盲目插队。<strong>可以避免线程唤醒带来的空档期，提高效率</strong>（下一个线程由挂起到运行）</p><p>举例：在线程1至此那个unlock释放锁之后，由于此时等待队列【线程2 线程3 线程4】线程2等待时间最久，所以线程2先得到执行，如果这个时候线程5恰好去执行lock()，由于<code>ReentrantLock</code>发现此时并没有线程持有Lock这把锁（线程2还没有来得及获取到，需要时间），线程5可以插队，直接拿到这把锁，这就是<code>ReentrantLock</code>默认的公平策略，也就是不公平。</p><p><code>ReentrantLock</code>默认是非公平锁，但是可以在参数填写true设置成公平锁</p><p><img src="http://pics.oncevan.cn/img/1586055172117.png" alt=""></p><p><img src="http://pics.oncevan.cn/img/1586055192675.png" alt=""></p><h3 id="2-4、共享锁和排他锁"><a href="#2-4、共享锁和排他锁" class="headerlink" title="2.4、共享锁和排他锁"></a>2.4、共享锁和排他锁</h3><p>排他锁：又称独占锁、独享锁，如syncronized</p><p>共享锁：又称读锁，获得共享锁之后，可以查看但无法修改和删除数据，其他线程此时也可以获取到共享锁，也可以查看但<strong>无法修改和删除数据</strong></p><p>共享锁和排他锁的典型是读写锁<code>ReentrantReadWriteLock</code>，其中<strong>读锁是共享锁</strong>，<strong>写锁是独享锁</strong></p><h4 id="读写锁的作用"><a href="#读写锁的作用" class="headerlink" title="读写锁的作用"></a>读写锁的作用</h4><ul><li>在没有读写锁之前，我们假设使用<code>ReentrantLock</code>，那么虽然我们保证了线程安全，但也浪费了一定的资源：多个读操作同时进行，并没有线程安全问题</li><li>在读的地方使用读锁，在写的地方使用写锁，灵活控制，如果没有写锁的情况下，读是无阻塞的，提高了程序执行效率</li></ul><h4 id="读写锁的规则"><a href="#读写锁的规则" class="headerlink" title="读写锁的规则"></a>读写锁的规则</h4><ul><li>多个线程只申请读锁，都可以申请得到</li><li>如果有一个线程已经占用了读锁，则此时其他线程如果要申请写锁，则申请写锁的线程会一直等待释放读锁</li><li>如果有一个线程已经占用了写锁，则此时其他线程如果申请写锁或读锁，则申请得线程会一直等待释放写锁</li><li>一句话总结：要么是一个或多个线程同时有读锁，要么是一个线程又写锁，但是两者不会同时出现（<strong>要么多读，要么一写</strong>）</li></ul><h4 id="读锁插队策略"><a href="#读锁插队策略" class="headerlink" title="读锁插队策略"></a>读锁插队策略</h4><p>情景：假设线程2和线程4正在同时读取，线程3想要写入，拿不到锁，于是进入等待队列，线程5不在队列里，现在过来想要读取</p><p>此时有两种策略：</p><ul><li>策略1：获得读锁，和线程2和线程4同时读取<ul><li>读可以插队，效率高</li><li>但是容易造成饥饿，假如线程5-1000都想要读，线程3就一直不能执行，造成饥饿</li></ul></li><li>策略2：把线程5加入等待队列就可以<strong>避免饥饿</strong>【ReentrantReadWriteLock的实现选择了策略2】</li></ul><p>非公平的情况，写锁可以随时插队；读锁只有在等待队列的头结点是读锁的情况下，这个时候进来的读取线程才可以插队，其他情况下都是不能插队的。</p><p>公平的情况，不允许插队，完全按照等待队列中的顺序来执行</p><h4 id="锁的升降级"><a href="#锁的升降级" class="headerlink" title="锁的升降级"></a>锁的升降级</h4><p><strong>为什么需要升降级</strong></p><ul><li>因为如果一个写入线程后面只有读操作，但是它如果一直占用写锁就会降低效率，如果这个时候把它降级为读锁，那么其他读取线程可以同时使用读锁，这样就提高了效率</li></ul><blockquote><p><strong>写锁支持降级为读锁，读锁不支持升级为写锁</strong></p></blockquote><p><strong>为什么不支持锁的升级</strong></p><p>因为有可能会造成<code>死锁</code>，假如有多个线程同时在使用读锁，这个时候如果有个读锁升级为写锁，读锁和写锁不能同时存在，又或者这个时候多个读取线程都想升级写锁，那么就会很容易造成死锁。</p><p><strong>适用场景</strong></p><p>相比于<code>ReentrantLock</code>适用于一般场合，<code>ReentrantReadWriteLock</code>适用于读多写少的情况，合理使用可以进一步提高并发效率</p><h3 id="2-5、自旋锁和阻塞锁"><a href="#2-5、自旋锁和阻塞锁" class="headerlink" title="2.5、自旋锁和阻塞锁"></a>2.5、自旋锁和阻塞锁</h3><p>阻塞或唤醒一个java线程需要操作系统切换CPU状态来完成，这种状态转换需要耗费处理器时间。</p><p>如果同步代码块中的内容过于简单，状态转换消耗的时间有可能比用户代码执行的时间还要长。在许多场景中，同步资源的锁定时间很短，为了这一小段时间去切换线程，线程挂起和恢复现场的花费可能会让系统得不偿失。</p><p>如果物理机器有多个处理器，能够让两个或两个以上的线程同时并行执行，我们就可以让后面那个请求锁的线程不放弃CPU的执行时间，看看持有锁的线程是否很快就会释放锁</p><p><strong>自旋锁：</strong>而为了让当前线程“稍等一下”，我们需要让当前线程进行自旋，如果自旋完成后前面锁定同步资源的线程已经释放了锁，那么当前线程就可以不必阻塞而是直接获取同步资源，从而避免切换线程的开销</p><p><strong>阻塞锁：</strong>和自旋锁相反，阻塞锁如果遇到没拿到锁的情况，会直接把线程阻塞，直到被唤醒</p><h4 id="自旋锁的缺点"><a href="#自旋锁的缺点" class="headerlink" title="自旋锁的缺点"></a>自旋锁的缺点</h4><ul><li>如果锁被占用的时间很长，那么自旋的线程只会浪费处理器资源</li><li>在自旋的过程中，一直消耗着CPU，所以虽然自旋锁的起始开销低于悲观锁，但是随着自旋时间的增长，开销也是线性增长的</li></ul><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><ul><li>自旋锁一般用于多核的服务器，在并发度不是特别高的情况下，比阻塞锁的效率高</li><li>另外，自旋锁适用于临界区比较短小的情况，否则如果把临界区很大（线程一旦拿到锁，很久以后才会释放），那也是不合适的</li></ul><h3 id="2-6、可中断锁"><a href="#2-6、可中断锁" class="headerlink" title="2.6、可中断锁"></a>2.6、可中断锁</h3><p>在Java中，<code>synchronized</code>就不是可中断锁，而<code>Lock</code>是可中断锁，因为tryLock()和lockInterruptibly都能响应中断</p><p>如果某一线程A正在执行锁中的代码，另一线程B正在等待获取该锁，可能由于等待时间过长，线程B不想等待了，想先处理其他事情，我们可以中断它，这种就是可中断锁。</p><h2 id="3、Java虚拟机对锁的优化"><a href="#3、Java虚拟机对锁的优化" class="headerlink" title="3、Java虚拟机对锁的优化"></a>3、Java虚拟机对锁的优化</h2><p><strong>自旋锁和自适应</strong>：在自旋一定次数后可能就会把自旋锁转为阻塞锁，可能这次自旋一百次后成功获取到同步资源，下次就不再自旋了等等</p><p><strong>锁消除</strong>：可能有些情况下不必要加锁，那么JVM可能就自动帮我们消除了锁</p><p><strong>锁粗化</strong>：有可能多次多同一个对象进行加锁解锁，可能就只用一个加锁解锁就可以了，JVM就会进行锁粗化优化。</p><h4 id="我们在写代码时如何优化锁和提高并发性能"><a href="#我们在写代码时如何优化锁和提高并发性能" class="headerlink" title="我们在写代码时如何优化锁和提高并发性能"></a>我们在写代码时如何优化锁和提高并发性能</h4><ol><li>缩小同步代码块</li><li>尽量不要锁住方法</li><li>减少请求锁的次数</li><li>避免人为制造“热点”</li><li>锁中尽量不要再包含锁</li><li>选择合适的锁类型或合适的工具类</li></ol></div><footer class="post-footer"><div class="post-tags"><a href="/tags/J-U-C/" rel="tag"># J.U.C</a> <a href="/tags/%E9%94%81/" rel="tag"># 锁</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/04/27/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="next" title="线程容器"><i class="fa fa-chevron-left"></i> 线程容器</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2020/04/29/ThreadLocal/" rel="prev" title="ThreadLocal">ThreadLocal <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a> <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a> <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a> <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a> <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a> <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a> <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a> <a href="#" class="bds_more" data-cmd="more"></a> <a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(0)[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="//bdimg.share.baidu.com/static/api/js/share.js?cdnversion="+~(-new Date/36e5)]</script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Evan Chou"><p class="site-author-name" itemprop="name">Evan Chou</p><p class="site-description motion-element" itemprop="description">oncevan的个人博客</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">16</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">11</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/oncevan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1069584938zxp@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、Lock接口"><span class="nav-number">1.</span> <span class="nav-text">1、Lock接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1、Lock简介、地位、作用"><span class="nav-number">1.1.</span> <span class="nav-text">1.1、Lock简介、地位、作用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2、为什么synchronized不够用？（为什么需要Lock？）"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.2、为什么synchronized不够用？（为什么需要Lock？）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3、Lock方法"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.3、Lock方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tryLock-、tryLock-long-time-TimeUnit-unit-、lockInterruptibly"><span class="nav-number">1.1.3.</span> <span class="nav-text">tryLock()、tryLock(long time,TimeUnit unit)、lockInterruptibly()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4、Lock的可见性保证"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4、Lock的可见性保证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拓展：happens-before"><span class="nav-number">1.2.</span> <span class="nav-text">拓展：happens-before</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、锁的分类"><span class="nav-number">2.</span> <span class="nav-text">2、锁的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1、乐观锁和悲观锁"><span class="nav-number">2.1.</span> <span class="nav-text">2.1、乐观锁和悲观锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#开销对比"><span class="nav-number">2.1.1.</span> <span class="nav-text">开销对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用场景"><span class="nav-number">2.1.2.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2、可重入锁和非可重入锁"><span class="nav-number">2.2.</span> <span class="nav-text">2.2、可重入锁和非可重入锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3、公平锁与非公平锁"><span class="nav-number">2.3.</span> <span class="nav-text">2.3、公平锁与非公平锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4、共享锁和排他锁"><span class="nav-number">2.4.</span> <span class="nav-text">2.4、共享锁和排他锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#读写锁的作用"><span class="nav-number">2.4.1.</span> <span class="nav-text">读写锁的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读写锁的规则"><span class="nav-number">2.4.2.</span> <span class="nav-text">读写锁的规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读锁插队策略"><span class="nav-number">2.4.3.</span> <span class="nav-text">读锁插队策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#锁的升降级"><span class="nav-number">2.4.4.</span> <span class="nav-text">锁的升降级</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5、自旋锁和阻塞锁"><span class="nav-number">2.5.</span> <span class="nav-text">2.5、自旋锁和阻塞锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自旋锁的缺点"><span class="nav-number">2.5.1.</span> <span class="nav-text">自旋锁的缺点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#适用场景"><span class="nav-number">2.5.2.</span> <span class="nav-text">适用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6、可中断锁"><span class="nav-number">2.6.</span> <span class="nav-text">2.6、可中断锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、Java虚拟机对锁的优化"><span class="nav-number">3.</span> <span class="nav-text">3、Java虚拟机对锁的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#我们在写代码时如何优化锁和提高并发性能"><span class="nav-number">3.0.1.</span> <span class="nav-text">我们在写代码时如何优化锁和提高并发性能</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Evan Chou</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">34.2k</span></div><div class="BbeiAn-info">赣ICP备 - <a target="_blank" href="http://www.beian.miit.gov.cn/">20006545号</a></div><div class="busuanzi-count"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user">访客总量</i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人 </span><span class="site-pv"><i class="fa fa-eye">访问总量</i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script></body></html><!-- rebuild by neat -->